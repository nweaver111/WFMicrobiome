library("vegan")
library("cluster")
library("gplots")
library ("ggplot2")
library(RColorBrewer)

#Load my own scripts:  adjust to your directory of choice
source('dnf_transforms.R')
source('dnf_matrix_corr.R')
source('dnf_misc.R')
source('dnf_multiple_tests.R')

#Adjust to your working directory if needed.

#Import metadata file into R
meta_master     = read.metatable("WFSTL_metadata_21Aug2019.txt",order=TRUE, lib.nms = "Lib")
#Import OTU sequence count files at different phylogenetic levels.
#Each call returns a list object containing count data, as well as transformed count data (relative abundance, binary,
#center-log ratio), shortened taxonomic names, etc.  The function calls below then extract the appropriately 
#transformed data to perform a given analysis, buffering the user from having to decide which dataset to use.
#The metadata imported above is passed into this function so each object stores all the metadata.  Subsequent
#calls to subset the data (i.e., choose a subset of subjects to analyze) work under the hood on both OTU data 
#and metadata
alltaxa_master  = read.otutable("WFSTL_alltaxa_cts_21Aug2019.txt",order = TRUE, rm.prev = FALSE, explicet=TRUE, otu.nms = "OTU_Name", transform = TRUE, meta = meta_master, drop.zeros = TRUE)
family_master  = read.otutable("WFSTL_family_cts_21Aug2019.txt",order = TRUE, rm.prev = FALSE, explicet=TRUE, otu.nms = "OTU_Name", transform = TRUE, meta = meta_master, drop.zeros = TRUE)
order_master   = read.otutable("WFSTL_order_cts_21Aug2019.txt",order = TRUE, rm.prev = FALSE, explicet=TRUE, otu.nms = "OTU_Name", transform = TRUE, meta = meta_master, drop.zeros = TRUE)
phylum_master   = read.otutable("WFSTL_phylum_cts_21Aug2019.txt",order = TRUE, rm.prev = FALSE, explicet=TRUE, otu.nms = "OTU_Name", transform = TRUE, meta = meta_master, drop.zeros = TRUE)

#Filter OTU files
# Require that an OTU be present in >5% of samples and that at least one sample have a %relative abundance >0.1% (remove rare taxa)
# We also remove any sequences with taxonomy line = "/Unclassified" or "/Bacteria".  These may not be 16S sequences)
alltaxa = otu.filter_otus(alltaxa_master, prevcut=5, racut=0.1, unc = TRUE, bact = TRUE)
family = otu.filter_otus(family_master, prevcut=5, racut=0.1, unc = TRUE, bact = TRUE)
order = otu.filter_otus(order_master, prevcut=5, racut=0.1, unc = TRUE, bact = TRUE)
phylum = otu.filter_otus(phylum_master, prevcut=5, racut=0.1, unc = TRUE, bact = TRUE)

#NICK NOTE: I am getting a warning for the previous four lines of code: the condition has length > 1 and only the first element will be used. Is this a problem? There is a lot of code to work through to figure out what might be wrong here, if anything...

#Sort OTUs by descending relative abundance (the OTU files I sent you may already be in this order)
alltaxa = otu.sort_otus(alltaxa, method = "ra_desc")
family = otu.sort_otus(family, method = "ra_desc")
order = otu.sort_otus(order, method = "ra_desc")
phylum = otu.sort_otus(phylum, method = "ra_desc")

#This saves key strokes, but need to be careful...
attach(alltaxa$meta)

#********************* Utilities *******************
otu.summary(alltaxa) # description of alltaxa object: n = 2750, OTUs = 210
otu.notu(alltaxa)    # number of OTUs in object: 210
otu.nsubj(alltaxa)   # number of subjects/libraries in object: 2750
otu.dim(alltaxa)     # number of OTUs and subjects/libraries in object: 2750 X 210
otu.subj_names(alltaxa) # return vector of subject/library names

otu.plot_counts(alltaxa) # histogram of read counts for all libraries
otu.plot_counts(alltaxa, mask = (SiteLocation == "India")) # histogram of read counts for India only

otu.summarize_read_cts(alltaxa)  # Descriptive stats of read counts across all subjects/libraries
otu.summarize_read_cts(alltaxa, factor = SiteLocation) # Descriptive stats of read counts by SiteLocation
otu.summarize_read_cts(alltaxa, factor = as.factor(paste(SiteLocation,Batch, sep="-"))) # Descriptive stats of read counts by SiteLocation x Batch

otu.summarize_read_cts(alltaxa, factor = as.factor(paste(SiteLocation,Batch, sep="-")), boxplot = TRUE) # Descriptive stats of read counts by SiteLocation x Batch
otu.summarize_read_cts(alltaxa, factor = as.factor(paste(SiteLocation,Batch, sep="-")), boxplot = TRUE, logtrans = TRUE) # Descriptive stats of read counts by SiteLocation x Batch

#NICK NOTE: The above two lines threw warning messages about parameters that can not be set. Need to look into these further.

otu.avg_ra(alltaxa)  # return mean relative abundances of taxa
otu.avg_ra(phylum)

alltaxa$nms   # OTU names
alltaxa$phynms  # Phylum names
alltaxa$orignms # Full taxonomy name

# Create object just with Guatemala's. All underlying data are subsetted
# By default, any OTUs with zero sequences in resulting object are shifted to "Other" category.
alltaxa_Guatemala = otu.subset_libs(alltaxa, mask = (SiteLocation == "Guatemala"))  
otu.summary(alltaxa_Guatemala)
alltaxa_Guatemala$meta  # access to metadata for HUU
meta_Guatemala = alltaxa_Guatemala$meta #creating new variable may be more convenient
detach(alltaxa$meta)

#Create a variable for supplement status:

meta_Guatemala$Supp_Status <- 0

for (i in 1:length(meta_Guatemala$Lib)) {
  if (meta_Guatemala$Timepoint[i] == "12Weeks" & meta_Guatemala$Arm[i] == 1) {
    meta_Guatemala$Supp_Status[i] <- 1
  }
  if (meta_Guatemala$Timepoint[i] == "34Weeks" & meta_Guatemala$Arm[i] != 3) {
    meta_Guatemala$Supp_Status[i] <- 1
  }
}

#********************* biodiversity *******************

#Check Goods coverage index:  
min(meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",]$Goods_3700Seqs, na.rm = TRUE)
#all are above 0.99, so great depth of sequencing coverage!

#Test for differences in common alpha diversity indices
summary(aov(Sobs_3700Seqs ~ Timepoint, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Not Significant!
summary(aov(Chao1_3700Seqs ~ Timepoint, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Not significnat!
summary(aov(ShannonE_3700Seqs ~ Timepoint, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Looks significant!
summary(aov(ShannonH_3700Seqs ~ Timepoint, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Looks significant!

summary(aov(Sobs_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Interaction is significant
summary(aov(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Interaction is significant
summary(aov(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",])) #Interaction is NOT significant

#Plot indices: nice way to understand ANOVAS from above
par(mfrow=c(1,3))
boxplot(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",], main="Richness\nGuatemala", ylab="Chao1")
boxplot(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",], main="Evenness\nGuatemala", ylab="H/Hmax")
boxplot(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_Guatemala[meta_Guatemala$Timepoint == "12Weeks" | meta_Guatemala$Timepoint == "34Weeks",], main="Diversity\nGuatemala", ylab="H")

counts <- as.data.frame(alltaxa$cts)
counts$Lib <- rownames(counts)

df <- merge(meta_Guatemala, counts, by = "Lib")
df2 <- df[df$Timepoint == "12Weeks" | df$Timepoint == "34Weeks",]
cts <- df2[,22:231]

df2 <- merge(df2, details, by.x = "SubjectID", by.y = "Subject.ID")
dim(df2)
#******************* Beta-diversity tests:  Adonis ***************************
perm = 1000
adonis(cts ~ Timepoint*Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)
adonis(cts ~ Timepoint + Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)

#Time point seems to matter here, but not supplement status or the interaction of supplement and time,
#mother, infant, or country.  So, is batch confounded??? NICK NOTE: Talk with Audrey

# Create object just with Pakistan. All underlying data are subsetted
# By default, any OTUs with zero sequences in resulting object are shifted to "Other" category.
attach(alltaxa$meta)
alltaxa_Pakistan = otu.subset_libs(alltaxa, mask = (SiteLocation == "Pakistan"))  
otu.summary(alltaxa_Pakistan)
alltaxa_Pakistan$meta  # access to metadata for HUU
meta_Pakistan = alltaxa_Pakistan$meta #creating new variable may be more convenient
detach(alltaxa$meta)

#Create a variable for supplement status:

meta_Pakistan$Supp_Status <- 0

for (i in 1:length(meta_Pakistan$Lib)) {
  if (meta_Pakistan$Timepoint[i] == "12Weeks" & meta_Pakistan$Arm[i] == 1) {
    meta_Pakistan$Supp_Status[i] <- 1
  }
  if (meta_Pakistan$Timepoint[i] == "34Weeks" & meta_Pakistan$Arm[i] != 3) {
    meta_Pakistan$Supp_Status[i] <- 1
  }
}

#********************* biodiversity *******************

#Check Goods coverage index:  
min(meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",]$Goods_3700Seqs, na.rm = TRUE)
#all are above 0.99, so great depth of sequencing coverage!

#Test for differences in common alpha diversity indices
summary(aov(Sobs_3700Seqs ~ Timepoint, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Not Significant!
summary(aov(Chao1_3700Seqs ~ Timepoint, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Not significnat!
summary(aov(ShannonE_3700Seqs ~ Timepoint, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Looks significant!
summary(aov(ShannonH_3700Seqs ~ Timepoint, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Looks significant!

summary(aov(Sobs_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",])) #Interaction is NOT significant

#Plot indices: nice way to understand ANOVAS from above
par(mfrow=c(1,3))
boxplot(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",], main="Richness\nPakistan", ylab="Chao1")
boxplot(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",], main="Evenness\nPakistan", ylab="H/Hmax")
boxplot(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_Pakistan[meta_Pakistan$Timepoint == "12Weeks" | meta_Pakistan$Timepoint == "34Weeks",], main="Diversity\nPakistan", ylab="H")

counts <- as.data.frame(alltaxa$cts)
counts$Lib <- rownames(counts)

df <- merge(meta_Pakistan, counts, by = "Lib")
df2 <- df[df$Timepoint == "12Weeks" | df$Timepoint == "34Weeks",]
cts <- df2[,22:231]

dim(df2) #160 observations
length(unique(df2$SubjectID)) #105 women total
length((df2[df2$Timepoint == '12Weeks',1])) #63 women at 12 weeks
length(unique(df2[df2$Timepoint == '34Weeks',1])) #97 women at 34 weeks
#******************* Beta-diversity tests:  Adonis ***************************
perm = 1000
adonis(cts ~ Timepoint*Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)
adonis(cts ~ Timepoint + Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)


# Create object just with DRC. All underlying data are subsetted
# By default, any OTUs with zero sequences in resulting object are shifted to "Other" category.
attach(alltaxa$meta)
alltaxa_DRC = otu.subset_libs(alltaxa, mask = (SiteLocation == "DRC"))  
otu.summary(alltaxa_DRC)
alltaxa_DRC$meta  # access to metadata for HUU
meta_DRC = alltaxa_DRC$meta #creating new variable may be more convenient
detach(alltaxa$meta)

#Create a variable for supplement status:

meta_DRC$Supp_Status <- 0

for (i in 1:length(meta_DRC$Lib)) {
  if (meta_DRC$Timepoint[i] == "12Weeks" & meta_DRC$Arm[i] == 1) {
    meta_DRC$Supp_Status[i] <- 1
  }
  if (meta_DRC$Timepoint[i] == "34Weeks" & meta_DRC$Arm[i] != 3) {
    meta_DRC$Supp_Status[i] <- 1
  }
}

#********************* biodiversity *******************

#Check Goods coverage index:  
min(meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",]$Goods_3700Seqs, na.rm = TRUE)
#all are above 0.99, so great depth of sequencing coverage!

#Test for differences in common alpha diversity indices
summary(aov(Sobs_3700Seqs ~ Timepoint, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Not Significant!
summary(aov(Chao1_3700Seqs ~ Timepoint, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Not significnat!
summary(aov(ShannonE_3700Seqs ~ Timepoint, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Not significant!
summary(aov(ShannonH_3700Seqs ~ Timepoint, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Not significant!

summary(aov(Sobs_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Interaction is NOT significant
summary(aov(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",])) #Interaction is NOT significant

#Plot indices: nice way to understand ANOVAS from above
par(mfrow=c(1,3))
boxplot(Chao1_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",], main="Richness\nDRC", ylab="Chao1")
boxplot(ShannonE_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",], main="Evenness\nDRC", ylab="H/Hmax")
boxplot(ShannonH_3700Seqs ~ Timepoint * Supp_Status, data = meta_DRC[meta_DRC$Timepoint == "12Weeks" | meta_DRC$Timepoint == "34Weeks",], main="Diversity\nDRC", ylab="H")

counts <- as.data.frame(alltaxa$cts)
counts$Lib <- rownames(counts)

df <- merge(meta_DRC, counts, by = "Lib")
df2 <- df[df$Timepoint == "12Weeks" | df$Timepoint == "34Weeks",]
cts <- df2[,22:231]

dim(df2) #233 observations
length(unique(df2$SubjectID)) #157 women total
length((df2[df2$Timepoint == '12Weeks',1])) #91 women at 12 weeks
length(unique(df2[df2$Timepoint == '34Weeks',1])) #142 women at 34 weeks
#******************* Beta-diversity tests:  Adonis ***************************
perm = 1000
adonis(cts ~ Timepoint*Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)
adonis(cts ~ Timepoint + Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)

# Create object just with India. All underlying data are subsetted
# By default, any OTUs with zero sequences in resulting object are shifted to "Other" category.
attach(alltaxa$meta)
alltaxa_India = otu.subset_libs(alltaxa, mask = (SiteLocation == "India"))  
otu.summary(alltaxa_India)
alltaxa_India$meta  # access to metadata for HUU
meta_India = alltaxa_India$meta #creating new variable may be more convenient
detach(alltaxa$meta)

#Create a variable for supplement status:

meta_India$Supp_Status <- 0

for (i in 1:length(meta_India$Lib)) {
  if (meta_India$Timepoint[i] == "12Weeks" & meta_India$Arm[i] == 1) {
    meta_India$Supp_Status[i] <- 1
  }
  if (meta_India$Timepoint[i] == "34Weeks" & meta_India$Arm[i] != 3) {
    meta_India$Supp_Status[i] <- 1
  }
}

#********************* biodiversity *******************

#Check Goods coverage index:  
min(meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",]$Goods_3700Seqs, na.rm = TRUE)
#all are above 0.99, so great depth of sequencing coverage!

#Test for differences in common alpha diversity indices
summary(aov(Sobs_3700Seqs ~ Timepoint, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",])) #Not Significant!
summary(aov(Chao1_3700Seqs ~ Timepoint, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",])) #Not significnat!
summary(aov(ShannonE_3700Seqs ~ Timepoint, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",])) #Not significant!
summary(aov(ShannonH_3700Seqs ~ Timepoint, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",])) #Not significant!

##No interaction model for India because no one is on the supplement at 12 weeks in this data.

#Plot indices: nice way to understand ANOVAS from above
par(mfrow=c(1,3))
boxplot(Chao1_3700Seqs ~ Timepoint + Supp_Status, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",], main="Richness\nIndia", ylab="Chao1")
boxplot(ShannonE_3700Seqs ~ Timepoint + Supp_Status, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",], main="Evenness\nIndia", ylab="H/Hmax")
boxplot(ShannonH_3700Seqs ~ Timepoint + Supp_Status, data = meta_India[meta_India$Timepoint == "12Weeks" | meta_India$Timepoint == "34Weeks",], main="Diversity\nIndia", ylab="H")

counts <- as.data.frame(alltaxa$cts)
counts$Lib <- rownames(counts)

df <- merge(meta_India, counts, by = "Lib")
df2 <- df[df$Timepoint == "12Weeks" | df$Timepoint == "34Weeks",]
cts <- df2[,22:231]

dim(df2) #191 observations
length(unique(df2$SubjectID)) #102 women total
length((df2[df2$Timepoint == '12Weeks',1])) #97 women at 12 weeks
length(unique(df2[df2$Timepoint == '34Weeks',1])) #94 women at 34 weeks
#******************* Beta-diversity tests:  Adonis ***************************
perm = 1000
adonis(cts ~ Timepoint*Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)
adonis(cts ~ Timepoint + Supp_Status, data = df2, permutations = perm, method = "bray", strata = df2$SubjectID)
